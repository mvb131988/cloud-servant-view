<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Getting Started: Serving Web Content</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>

	<div id="control" style="position:relative; margin-bottom:20px;">
		<div style="float:left; margin-right:20px;">
			<form action="/logout" method="post">
				<input type="submit" value="Logout" style="width: 150px; height: 80px">
			</form>
		</div>
		<div>
			<input id="share" type="submit" value="Share" style="width: 150px; height: 80px">
		</div>
	</div>
    <div id="share-url" style="position:relative; margin-bottom:20px;">
	</div>
    
    <table id="directories" align="center" border="0" cellspacing="5" cellpadding="0"></table>
    <table id="bmp-gallery" align="center" border="0" cellspacing="5" cellpadding="0"></table>
    <table id="jpg-gallery" align="center" border="1" cellspacing="5" cellpadding="0"></table>
	<table id="bigImgTable" align="center" cellspacing="10px">
		<tr>
			<td align="right">
				<img id="prevImg"></img>
				<img id="nextImg"></img>
				<img id="cancelImg"></img>
			</td>
		</tr>
		<tr>
			<td valign="top"><img id="bigImg"></img></td>
		</tr>
	</table>
	<div>
		<table id="loadingImgTable" align="center">
			<tr>
				<td><img id="loadingImg"></img></td>
			</tr>
		</table>
	</div>
	<img id="jpgIconImg"></img>
</body>

<script>
	/////////////////// Loading image /////////////////////
	function initResourceImage(resourceDescriptor, bigImageControl) {
		var oReq = new XMLHttpRequest();
		oReq.open("POST", "/resource-img", true);
		oReq.responseType = "arraybuffer";
		
		oReq.onload = function(oEvent) {
		  var blob = new Blob([oReq.response], {type: resourceDescriptor.type});
		  var objectURL = URL.createObjectURL(blob);
		  
		  resourceDescriptor.obj.src = objectURL;
		  
		  if(resourceDescriptor.next != null) {
		  	initResourceImage(resourceDescriptor.next, bigImageControl);
		  } else {
		  	initGalleries(bigImageControl);
		  }
		};
		oReq.send(resourceDescriptor.name);
	}
	///////////////////////////////////////////////////////

    ////////////////////////////////////////////////////////////////
	///// bmp-gallery, jpg-galleries + dirs navigation /////////////
	////////////////////////////////////////////////////////////////
	
	// Getting list of all images for bmp-gallery, jpg-gallery 
    // and dirs navigation section. Hand over control to dirs 
    // navigation section and bmp-gallery, jpg-gallery 
    // initialization methods 
	function initGalleries(bigImageControl) {
		var imgsRequest = new XMLHttpRequest();
		imgsRequest.open("POST", "/list", true);
		imgsRequest.onreadystatechange = function() {
		    if (this.readyState == 4 && this.status == 200) {
		        //init images
		        var bmpImgs = JSON.parse(this.responseText).bmps;
		        var jpgImgs = JSON.parse(this.responseText).jpgs;
		        
		        //Both maps contain .bmp image names and they are used in case when
				//.jpg has paired .bmp image
		        var bmpNextImgs = new Map();
				var bmpPrevImgs = new Map();
		        initImgMaps(bmpImgs, bmpNextImgs, bmpPrevImgs); 
		        
		        //Both maps contain .jpg image names and they are used in case when
				//.jpg is not paired to .bmp image
		        var jpgNextImgs = new Map();
				var jpgPrevImgs = new Map();
		        initImgMaps(jpgImgs, jpgNextImgs, jpgPrevImgs); 
		        
		        //process dirs
		        var dirs = JSON.parse(this.responseText).dirs;
		        initDirectories(dirs, bigImageControl);
		        
		        //init sharing url
		        initShareUrl();
		        
		        loadBmpImg(0,0,0, 
		        		   bmpImgs, 
		        		   bmpNextImgs, 
		        		   bmpPrevImgs, 
		        		   bigImageControl, 
		        		   bmpGalleryTable);
		        
		        loadJpgImg(0,0,0, 
		        		   jpgImgs, 
		        		   jpgNextImgs, 
		        		   jpgPrevImgs, 
		        		   bigImageControl, 
		        		   jpgGalleryTable,
		        		   jpegIconImgDescriptor.obj.src);
		    }
		};
		imgsRequest.send(currentPath);
	}
	
	//Loads single img, creates img element and inserts it
	//and then recursively invokes itself to load next image from
	//the bmp-imgs list.
	function loadBmpImg(index, 
						rowIndex, 
						cellIndex, 
						bmpImgs, 
						bmpNextImgs, 
						bmpPrevImgs, 
						bigImageControl,
						galleryTableContainer) 
	{
		if(index == bmpImgs.length) {return;}
		var imgId = bmpImgs[index];
	
		var oReq = new XMLHttpRequest();
		oReq.open("POST", "/img", true);
		oReq.responseType = "arraybuffer";
		oReq.onload = function(oEvent) {
		  var blob = new Blob([oReq.response], {type: "image/bmp"});
		  var objectURL = URL.createObjectURL(blob);
		  
		  // select or create row		  
		  var row = null;
		  if(cellIndex == 0) {
		  	//new row is started
		  	row = galleryTableContainer.insertRow(rowIndex);
		  } 
		  else {row = galleryTableContainer.rows[rowIndex];}
		  
		  // create image object
		  var img = new Image();
		  img.id = bmpImgs[index];
		  img.row = row;
		  img.cellIndex = cellIndex;
		  img.onload  = cellIndex == nHc-1 || index == bmpImgs.length-1 ? resizeRow : null;
		  img.src = objectURL;
		  img.addEventListener("click", bigImageControl.smallImageClickHandler);
		  img.nextImgs = bmpNextImgs;
		  img.prevImgs = bmpPrevImgs;
		  img.imgType = 'bmp';
		  
		  //create cell and pass control further down the recursion chain			  
		  var cell = row.insertCell(cellIndex);
		  cell.appendChild(img);
		  if(cellIndex < nHc-1) {
		  	loadBmpImg(++index, 
		  			   rowIndex, 
		  			   ++cellIndex, 
		  			   bmpImgs, 
		  			   bmpNextImgs, 
		  			   bmpPrevImgs, 
		  			   bigImageControl,
		  			   galleryTableContainer);
		  }
		  else {
		  	loadBmpImg(++index, 
		  			   ++rowIndex, 
		  			   0, 
		  			   bmpImgs, 
		  			   bmpNextImgs, 
		  			   bmpPrevImgs, 
		  			   bigImageControl,
		  			   galleryTableContainer);
		  }
		};
		
		oReq.send(currentPath + imgId);
	}
	
	//Loads single img, creates img element and inserts it
	//and then recursively invokes itself to load next image from
	//the jpg-imgs list.
	function loadJpgImg(index, 
						rowIndex, 
						cellIndex, 
						jpgImgs, 
						jpgNextImgs, 
						jpgPrevImgs, 
						bigImageControl,
						galleryTableContainer,
						jpgIconSrc) 
	{
		if(index == jpgImgs.length) {return;}
		var imgId = jpgImgs[index];
	
		// select or create row		  
		var row = null;
		if(cellIndex == 0) {
			//new row is started
		  	row = galleryTableContainer.insertRow(rowIndex);
		} 
		else {row = galleryTableContainer.rows[rowIndex];}
		  
		// create image object
		var img = new Image();
		img.id = jpgImgs[index];
		img.row = row;
		img.cellIndex = cellIndex;
		img.onload  = cellIndex == nHc-1 || index == jpgImgs.length-1 ? resizeRow : null;
		img.src = jpgIconSrc;
		img.addEventListener("click", bigImageControl.smallImageClickHandler);
		img.nextImgs = jpgNextImgs;
		img.prevImgs = jpgPrevImgs;
		img.imgType = 'jpg';
		  
		//create cell and pass control further down the recursion chain			  
		var cell = row.insertCell(cellIndex);
		cell.appendChild(img);
		if(cellIndex < nHc-1) {
			loadJpgImg(++index, 
		  			   rowIndex, 
		  			   ++cellIndex, 
		  			   jpgImgs, 
		  			   jpgNextImgs, 
		  			   jpgPrevImgs, 
		  			   bigImageControl,
		  			   galleryTableContainer,
		  			   jpgIconSrc);
		}
		else {
			loadJpgImg(++index, 
		  			   ++rowIndex, 
		  			   0, 
		  			   jpgImgs, 
		  			   jpgNextImgs, 
		  			   jpgPrevImgs, 
		  			   bigImageControl,
		  			   galleryTableContainer,
		  			   jpgIconSrc);
		}
	}
	
	//when a single row is completely filled with the images,
	//find the minimum height amongst them and change their height
	//to this minimum value
	function resizeRow() {
	  var i;
	  var min = 2147483647;
	  for(i=0; i<this.row.cells.length; i++) {
	  	var h = this.row.cells[i].childNodes[0].height;
	  	min = min >= h ? h : min;
	  }
	  for(i=0; i<this.row.cells.length; i++) {
	    this.row.cells[i].childNodes[0].height = min;		  
	  }
	}
	
	//TODO: parameterize to include .jpg case here
	//init maps of <img name> -> <next img name>, 
	//			   <img name> -> <prev img name>
	function initImgMaps(imgs, bmpNextImgs, bmpPrevImgs) {
		for(var i=0; i<imgs.length; i++) {
			var next = i < imgs.length - 1 ? imgs[i+1] : null;
			bmpNextImgs.set(imgs[i], next);
			var prev = i > 0 ? imgs[i-1] : null;
			bmpPrevImgs.set(imgs[i], prev);
		}
	}
	
	///////////////////////////////////////////////////////
	
	/////////////////// Directories list //////////////////
	//exposes list of existed directories for the current directory.
	function initDirectories(dirs, bigImageControl) {
		var i = 0;
		var rowIndex = 0;
		while(i < dirs.length) {
			row = dirTable.insertRow(rowIndex);
			
			for(var cellIndex = 0; cellIndex<nHc; cellIndex++) {
				if(i == dirs.length) break;
				
				var dirName;
				//Special case for the first element.
				//First element is folder back to the previous directory
				if(cellIndex == 0 && rowIndex == 0) {
					if(currentPath.localeCompare("/") != 0) {
						//"back" value
						dirName = dirs[i]; 
					} else {
						i++;
						dirName = dirs[i];
					}
				} else {
					dirName = dirs[i];
				}				
				i++;
				
				//<div style="position: relative;">
				//	<div style="text-align: center;">
				//		<img src="blob:http://92.115.183.17:53131/6d0a2264-0150-41a7-b865-9d66346a6fcb">
				//	</div>
				//	<span>nastia_fotoset_03</span>
				//</div>
				
				var div0 = document.createElement("div");
				div0.style = "position: relative;"
				var div1 = document.createElement("div");
				div1.style = "text-align: center;";
				var span = document.createElement("span");
				span.textContent = dirName;
				
				div0.appendChild(div1);
				div0.appendChild(span);
				
				var localDirImg = new Image();
				localDirImg.src = dirImg.src;
				div1.append(localDirImg);
				changeDirHandler(div1, dirName, bigImageControl);
				
				var cell = row.insertCell(cellIndex);
		  		cell.appendChild(div0);
			}
			rowIndex++;
		}
	}
	
	//Allows directory navigation(in depth traversal). When directory changes, change current path
	//and dispose bmp-gallery and dirs objects
	function changeDirHandler(element, dirName, bigImageControl) {
		element.addEventListener('click', function() {
			if(dirName.localeCompare("back") == 0) {
				//special case of back path (move to parent directory)
				//calculate path
				currentPath = currentPath.substring(0, currentPath.lastIndexOf("/"));
				currentPath = currentPath.substring(0, currentPath.lastIndexOf("/")+1);
			} else {
				currentPath += dirName + "/";
			}
			
			disposeDirs();
			disposeGalleryTable(bmpGalleryTable);
			disposeGalleryTable(jpgGalleryTable);
			
			//remove sharing url
			shareUrlDiv.innerHTML = "";
			
			initGalleries(bigImageControl);
		});
	}
	
	///////////////////////////////////////////////////////
	
	////// Dispose bmp-gallery and dirs tables ///////////
	function disposeDirs() {
		for (var i = dirTable.rows.length-1; i > -1; i--) {
    		dirTable.deleteRow(i);
		}
	}
	
	function disposeGalleryTable(galleryTable) {
		for (var i = galleryTable.rows.length-1; i > -1; i--) {
    		galleryTable.deleteRow(i);
		}
	}
	///////////////////////////////////////////////////////
	
	/////////////////// Helpers  //////////////////////////
	function findById(id, elements) {
		var i;
		for(i=0; i<elements.length; i++) {
			if(elements[i].id == id) {return elements[i];}
		}
		return null;
	}
	///////////////////////////////////////////////////////
	
	/////////////////// Share functions  //////////////////
	function shareLinkContext(shareButton, shareUrlDiv) {
		shareButton.addEventListener("click", function(){
		
			var oReq = new XMLHttpRequest();
			oReq.open("POST", "/sharing/create", true);
			oReq.onload = function(oEvent) {
				var id = oReq.responseText;
				shareUrlDiv.innerHTML = 'Sharing url: ' + 'sharing/imgs?path-id=' + id;
			};
			oReq.send(currentPath);
		
		});
	}	
	
	function initShareUrl() {
		var oReq = new XMLHttpRequest();
		oReq.open("POST", "/sharing/get", true);
		oReq.onload = function(oEvent) {
			var id = oReq.responseText;
			if(id) shareUrlDiv.innerHTML = 'Sharing url: ' + 'sharing/imgs?path-id=' + id;
		};
		oReq.send(currentPath);
	}	
	///////////////////////////////////////////////////////
	
	/////////////////// big image control  ////////////////
	
	function BigImageControl(bmpGalleryTable, jpgGalleryTable, ih) {
		
		//current small img object
		var currentSmallImg = null;
		
		//loading/progress image container
		var loadingImgTable = document.getElementById("loadingImgTable");
		document.body.removeChild(loadingImgTable.parentNode);
		loadingImgTable.parentNode.style.marginTop = Math.floor(ih/3) + "px";
		
		//before big image is loaded loading image is shown
		this.loadingImg = loadingImgTable.getElementsByTagName("img")[0];
		
		//container for bigImg and control(left, right, cancel buttons) elements
		var bigImgTable = document.getElementById("bigImgTable");
		document.body.removeChild(bigImgTable);
		
		//bigImg object
		var bigImg = findById("bigImg", bigImgTable.getElementsByTagName("img"));
		bigImg.width = iw-100;
		
		//cancel button(cancelImg) on click handler
		var closeBigImgClickHandler = function() {
			bigImgTable.parentNode.removeChild(bigImgTable);
			document.body.appendChild(bmpGalleryTable);
			document.body.appendChild(jpgGalleryTable);
		}
		
		//loading cancel button object
		this.cancelImg = findById("cancelImg", bigImgTable.getElementsByTagName("img"));
		this.cancelImg.width = Math.floor(bigImg.width/10);
		this.cancelImg.addEventListener("click", closeBigImgClickHandler);
	
		//Loads big .jpg image by small image(.bmp) name		
		var loadBigImage = function(smallImgName) {
			//replace bmp extension to jpg
			var bigImgName = smallImgName.substring(0,smallImgName.indexOf(".")) + ".jpg";
		
			var oReq = new XMLHttpRequest();
			oReq.open("POST", "/big-img", true);
			oReq.responseType = "arraybuffer";
			
			oReq.onload = function(oEvent) {
			  var blob = new Blob([oReq.response], {type: "image/jpg"});
			  var objectURL = URL.createObjectURL(blob);
			  
			  bigImg.src = objectURL;
			  bigImg.name = smallImgName.substring(0,smallImgName.indexOf("."));
			  document.body.removeChild(loadingImgTable.parentNode);
			  document.body.appendChild(bigImgTable);
			};
			oReq.send(currentPath + bigImgName);
		}
		
		//next button on click handler
		var loadNextBigImgClickHandler = function() {
			var nextImgs = currentSmallImg.nextImgs;
			var next = nextImgs.get(bigImg.name + "." + currentSmallImg.imgType);
			if(next != null) {
				bigImgTable.parentNode.removeChild(bigImgTable);
				document.body.appendChild(loadingImgTable.parentNode);
				loadBigImage(next);
			}
		}
		
		//loading nextImg button object
		this.nextImg = findById("nextImg", bigImgTable.getElementsByTagName("img"));
		this.nextImg.width = Math.floor(bigImg.width/10);
		this.nextImg.addEventListener("click", loadNextBigImgClickHandler);
		
		//prev button on click handler
		var loadPrevBigImgClickHandler = function() {
			var prevImgs = currentSmallImg.prevImgs;
			var prev = prevImgs.get(bigImg.name + "." + currentSmallImg.imgType);
			if(prev != null) {
				bigImgTable.parentNode.removeChild(bigImgTable);
				document.body.appendChild(loadingImgTable.parentNode);
				loadBigImage(prev);
			}
		}
		
		//loading prevImg button object
		this.prevImg = findById("prevImg", bigImgTable.getElementsByTagName("img"));
		this.prevImg.width = Math.floor(bigImg.width/10);
		this.prevImg.addEventListener("click", loadPrevBigImgClickHandler);
			
		//Sets currently chosen image. Prev and next navigation is carried out based
		//on this value				
		this.smallImageClickHandler = function() {
			currentSmallImg = this;
			bmpGalleryTable.parentNode.removeChild(bmpGalleryTable);
			jpgGalleryTable.parentNode.removeChild(jpgGalleryTable);
			document.body.appendChild(loadingImgTable.parentNode);
			loadBigImage(this.id);
		}
		
	}
	
	///////////////////////////////////////////////////////
	
	/////////////////// global  space /////////////////////
	var iw = window.innerWidth;
	var ih = window.innerHeight;
	//number of horizontal cells in bmp-gallery table
	var nHc = Math.floor(iw/200);
	
	//consider table cellspacing
	while((nHc*200 + nHc*5*2) > iw) {
		nHc--;
	} 
	
	// table for unprocessed(exists paired .bmp image) .jpg images
	var bmpGalleryTable = document.getElementById("bmp-gallery");
	// table for unprocessed(no paired .bmp image) .jpg images
	var jpgGalleryTable = document.getElementById("jpg-gallery");
	
	var dirTable = document.getElementById("directories");
	var controlDiv = document.getElementById("control");
	
	// common img for all unprocessed .jpg images
	var jpgIconImg = document.getElementById("jpgIconImg");
	document.body.removeChild(jpgIconImg);
	
	var bigImageControl = new BigImageControl(bmpGalleryTable, jpgGalleryTable, ih);
	
	//share button
	var shareButton = findById("share", controlDiv.getElementsByTagName("input"));
	//share url
	var shareUrlDiv = document.getElementById("share-url");
	shareLinkContext(shareButton, shareUrlDiv);
	
	//img object for dir image
	var dirImg = new Image();
	
	var currentPath = "/";
	///////////////////////////////////////////////////////

	var loadingDescriptor = new Object();
	loadingDescriptor.obj=bigImageControl.loadingImg;
	loadingDescriptor.type="image/gif";
	loadingDescriptor.name="loading.gif";
	loadingDescriptor.next = null;
	
	var cancelDescriptor = new Object();
	cancelDescriptor.obj=bigImageControl.cancelImg;
	cancelDescriptor.type="image/png";
	cancelDescriptor.name="cancel.png";
	cancelDescriptor.next = null;
	
	var prevImgDescriptor = new Object();
	prevImgDescriptor.obj=bigImageControl.prevImg;
	prevImgDescriptor.type="image/png";
	prevImgDescriptor.name="left.png";
	prevImgDescriptor.next=null;
	
	var nextImgDescriptor = new Object();
	nextImgDescriptor.obj=bigImageControl.nextImg;
	nextImgDescriptor.type="image/png";
	nextImgDescriptor.name="right.png";
	nextImgDescriptor.next=null;
	
	var dirImgDescriptor = new Object();
	dirImgDescriptor.obj=dirImg;
	dirImgDescriptor.type="image/png";
	dirImgDescriptor.name="dir.png";
	dirImgDescriptor.next=null;

	var jpegIconImgDescriptor = new Object();
	jpegIconImgDescriptor.obj=jpgIconImg;
	jpegIconImgDescriptor.type="image/png";
	jpegIconImgDescriptor.name="jpeg-icon.png";
	jpegIconImgDescriptor.next=null;

	loadingDescriptor.next = cancelDescriptor;
	cancelDescriptor.next = prevImgDescriptor;
	prevImgDescriptor.next = nextImgDescriptor;
	nextImgDescriptor.next = dirImgDescriptor;
	dirImgDescriptor.next = jpegIconImgDescriptor;
	
	initResourceImage(loadingDescriptor, bigImageControl);

</script>

</html>